<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <title>Book List</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Nanum+Gothic:wght@800&display=swap"
      rel="stylesheet"
    />
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
  </head>
  <style>
    .recommendation-btn {
      transition: background-color 0.3s ease-in-out;
    }

    .read {
      background-color: green;
    }

    .not-read {
      background-color: red;
    }

    /* Remove the button border */
    .btn {
      border: none;
    }
    .read:hover {
      background-color: red;
    }

    .not-read:hover {
      background-color: green;
    }

    /* Display comment input when toggled to 'Read' */
    .comment-input {
      display: none;
    }
    .read + .comment-input {
      display: block;
    }

    /* 전체 페이지 스타일 */
    body {
      background-color: #f8f9fa;
    }

    /* 모달 스타일 */
    #modal.modal-overlay {
      display: none;
      align-items: center;
      justify-content: center;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5); /* 반투명한 배경 */
      z-index: 1000; /* 높은 z-index로 화면 상의 최상위 레이어로 표시 */
    }

    #modal .modal-window {
      background-color: #ffffff;
      border-radius: 10px;
      padding: 20px;
      width: 300px;
      max-width: 90%;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      position: relative;
      z-index: 1001; /* 모달 창을 오버레이 위로 표시 */
    }

    #modal .title {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    #modal .close-area {
      cursor: pointer;
      font-size: 20px;
    }

    /* 테이블 스타일 */
    .table th,
    .table td {
      vertical-align: middle;
    }

    /* 모달 내용 스타일 */
    #input-text {
      width: 100%;
      border: 1px solid #ccc;
      padding: 8px;
      border-radius: 5px;
      margin-bottom: 10px;
    }

    /* 버튼 스타일 */
    .btn-open-modal {
      width: 100px;
    }
    #title {
      font-size: 20px;
    }

    /* 작은 화면에서 테이블 스타일 조정 */
    @media (max-width: 576px) {
      .table td {
        word-break: break-word;
      }
    }
  </style>

  <body style="text-align: center; font-family: 'Nanum Gothic', sans-serif">
    <div class="container mt-5">
      <h1 class="text-center mb-4">Book Wish List</h1>
      <table class="table table-bordered table-hover">
        <thead class="table-dark">
          <tr>
            <th id="title">Num</th>
            <th id="title">Title</th>
            <th id="title">Author</th>
            <th id="title">Comment</th>
            <th id="title">Check</th>
          </tr>
        </thead>
        <tbody>
          <tr th:each="book : ${books}">
            <td th:text="${book.num}" class="align-middle"></td>
            <td th:text="${book.title}" class="align-middle"></td>
            <td th:text="${book.author}" class="align-middle"></td>
            <td class="align-middle">
              <button
                class="btn btn-secondary btn-sm btn-open-modal"
                th:data-book-id="${book.num}"
                th:data-comment="${book.comment}"
              >
                COMMENT
              </button>
            </td>
            <td class="align-middle">
              <button
                class="btn btn-primary btn-sm toggle-btn recommendation-btn"
                th:classappend="${book.count == 1} ? 'read' : 'not-read'"
                th:attr="data-book-id=${book.num}, data-count=${book.count}"
              >
                <span th:if="${book.count == 1}">Read</span>
                <span th:if="${book.count == 0}">Not Read</span>
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div id="modal" class="modal-overlay">
      <div class="modal-window">
        <div class="title">
          <h2>COMMENT</h2>
          <div class="close-area">X</div>
        </div>
        <div class="content">
          <textarea
            style="border: 1px solid rgb(0, 0, 0)"
            id="input-text"
            rows="10"
            placeholder="Enter your comment..."
          ></textarea>
          <button id="save-button" class="btn btn-secondary btn-sm">
            SAVE
          </button>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const toggleButtons = document.querySelectorAll(".toggle-btn");
        const btnOpenModals = document.querySelectorAll(".btn-open-modal");
        const inputText = document.getElementById("input-text"); // textarea 요소
        const saveButton = document.getElementById("save-button"); // SAVE 버튼 요소

        toggleButtons.forEach((button) => {
          button.addEventListener("click", function () {
            const bookId = this.getAttribute("data-book-id");
            const currentCount = parseInt(this.getAttribute("data-count"));
            const buttonSpan = this.querySelector("span");

            fetch(`/toggleRecommend/${bookId}`)
              .then((response) => response.json())
              .then((data) => {
                if (data.success) {
                  this.setAttribute("data-count", data.newCount);
                  buttonSpan.textContent =
                    data.newCount === 1 ? "Read" : "Not Read";

                  if (data.newCount === 1) {
                    button.classList.add("read");
                    button.classList.remove("not-read");
                  } else {
                    button.classList.remove("read");
                    button.classList.add("not-read");
                  }
                } else {
                  console.error("Failed to toggle recommendation");
                }
              })
              .catch((error) => {
                console.error("Error:", error);
              });
          });
        });

        btnOpenModals.forEach((btnOpenModal) => {
          btnOpenModal.addEventListener("click", function () {
            const bookComment = this.getAttribute("data-comment");
            const bookId = this.getAttribute("data-book-id"); // 도서의 고유 ID 가져오기

            // textarea에 코멘트 내용을 표시
            inputText.value = bookComment || ""; // 코멘트가 없을 경우 빈 문자열 사용

            modalOn();
            saveButton.setAttribute("data-book-id", bookId); // SAVE 버튼에 도서의 고유 ID 설정
          });
        });

        // 모달 열기 버튼 이벤트 리스너
        function modalOn() {
          modal.style.display = "flex";
        }

        // 모달 닫기 버튼 이벤트 리스너
        const closeBtn = document.querySelector(".close-area");
        closeBtn.addEventListener("click", function () {
          modalOff();
        });

        // 저장 버튼 이벤트 리스너
        saveButton.addEventListener("click", function () {
          const newText = inputText.value; // 입력한 텍스트 가져오기

          const bookId = saveButton.getAttribute("data-book-id"); // SAVE 버튼에 저장된 도서 ID 가져오기

          // CSRF 토큰 가져오기
          const csrfToken = document
            .querySelector('meta[name="_csrf"]')
            .getAttribute("content");
          const csrfHeader = document
            .querySelector('meta[name="_csrf_header"]')
            .getAttribute("content");

          // 새로운 코멘트 내용을 데이터베이스에 저장하는 요청 보내기
          fetch(`/saveComment/${bookId}`, {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
              [csrfHeader]: csrfToken,
            },
            body: `content=${encodeURIComponent(newText)}`,
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                alert("코멘트가 저장되었습니다.");
                modalOff();
                location.reload();
              } else {
                alert("코멘트 저장에 실패했습니다.");
              }
            })
            .catch((error) => {
              console.error("Error:", error);
              alert("오류가 발생하여 코멘트 저장에 실패했습니다.");
            });
        });
        function modalOff() {
          modal.style.display = "none";
        }
      });
    </script>
  </body>
</html>
